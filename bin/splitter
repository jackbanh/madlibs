#!/usr/bin/ruby

require_relative '../lib/phrase_bucketer.rb'

MAX_TEXTS = 1000

corpuses = []

# Get all subdirectories under texts
dirs = Dir['./texts/*/']

dirs.each do |d|
  name = d.split("/").last
  bucketer = PhraseBucketer.new(name)

  # Corpus is a list of all text files inside the subdirectory
  corpus = Dir.glob("#{d}*.txt")

  next if corpus.empty?

  # Pick a random sample of files
  files = corpus.sample(MAX_TEXTS)
  files.each do |file|
    puts "Reading #{file}..."
    bucketer.add_text(File.read(file))
  end
  corpuses.push(bucketer)
end

Dir.mkdir "output" unless Dir.exist?("output")

corpuses.each do |bucket|
  # Write _1.txt and _2.txt files
  # phrase_buckets will have 2 buckets: 1 or 2 nouns to replace
  bucket.phrase_buckets.each do |bucket_number, phrases|
    bucket_file = "output/#{bucket.name}_#{bucket_number}.txt"
    File.open(bucket_file, "w") do |file|
      file.puts(phrases)
    end
    puts "Wrote #{bucket_file}."
  end

  # Write removed nouns
  noun_file = "output/#{bucket.name}_removed_nouns.txt"
  File.open(noun_file, "w") do |file|
    file.puts(bucket.removed_nouns.to_a)
  end
  puts "Wrote #{noun_file}."
  
  # bucket.tagged_phrase_buckets.each do |k,v|
  #   File.open("output/tagged_#{bucket.name}_#{k}.txt", "w") do |file|
  #     v.each {|line| file.puts line }
  #   end 
  # end
end